package config

import (
	"context"
	"os"

	"github.com/joho/godotenv"
	"gopkg.in/yaml.v3"
)

// Init initializes the environment variables
func Init(_ context.Context) error {
	return godotenv.Load(".env")
}

// getEnv returns the environment variable by the key
func getEnv(key string) string {
	return os.Getenv(key)
}

// Config describes the app configuration
type Config struct {
	// Logger describes the logging configuration
	Logger LoggerConf `yaml:"logger"`
	// Redis describes the redis configuration
	Redis RedisConf `yaml:"redis"`
	// PG describes the postgres configuration
	PG PGConf `yaml:"pg"`
	// HTTP describes the HTTP server configuration
	HTTP HTTPConf `yaml:"http"`
}

// Load parses the app configuration with provided path and returns it
func Load(path string) (conf Config, err error) {
	bb, err := os.ReadFile(path)
	if err != nil {
		return
	}
	if err = yaml.Unmarshal(bb, &conf); err != nil {
		return
	}

	return
}

// LoggerConf describes the logging configuration
type LoggerConf struct {
	Level string `yaml:"level"`
}

// RedisConf describes the redis configuration
type RedisConf struct {
	// Network describes the network type
	Network string `yaml:"network"`
	// Addr describes the redis address
	Addr string `yaml:"addr"`
	// Port describes the redis port
	Port string `yaml:"port"`
}

// SetToEnv sets the redis configuration to the environment variables
func (r RedisConf) SetToEnv() {
	os.Setenv("REDIS_NETWORK", r.Network)
	os.Setenv("REDIS_ADDR", r.Addr)
}

// PGConf describes the postgres configuration
type PGConf struct {
	// User describes the postgres user
	User string `yaml:"user"`
	// Password describes the postgres password
	Password string `yaml:"password"`
	// Database describes the postgres database
	Database string `yaml:"database"`
	// Host describes the postgres host
	Host string `yaml:"host"`
	// Port describes the postgres port
	Port string `yaml:"port"`
}

// SetToEnv sets the postgres configuration to the environment variables
func (pg PGConf) SetToEnv() {
	os.Setenv("PG_USER", pg.User)
	os.Setenv("PG_PASSWORD", pg.Password)
	os.Setenv("PG_DATABASE", pg.Database)
	os.Setenv("PG_HOST", pg.Host)
	os.Setenv("PG_PORT", pg.Port)
}

// HTTPConf describes the HTTP server configuration
type HTTPConf struct {
	Port    string `yaml:"port"`
	Timeout int    `yaml:"timeout"`
}
